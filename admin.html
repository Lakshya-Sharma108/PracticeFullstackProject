<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }

        body {
            min-height: 100vh;
            display: flex;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
        }

        /* SIDEBAR */
        .sidebar {
            width: 220px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 30px 20px;
            flex-shrink: 0;
        }

        .sidebar h2 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .sidebar p {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 25px;
        }

        .sidebar a {
            display: block;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            color: #cbd5e1;
            text-decoration: none;
            cursor: pointer;
            transition: 0.2s;
        }

        .sidebar a:hover, .sidebar a.active {
            background: #6366f1;
            color: white;
        }

        /* MAIN */
        .main {
            flex: 1;
            padding: 30px;
            overflow-x: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .logout {
            background: #ef4444;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
        }

        .logout:hover { background: #dc2626; }

        /* STATS CARD */
        .stats-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(10px);
            padding: 20px 25px;
            border-radius: 12px;
            flex: 1;
        }

        .stat-card h4 { color: #94a3b8; font-size: 13px; margin-bottom: 6px; }
        .stat-card span { font-size: 28px; font-weight: 700; }

        /* CARD */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        /* FORM */
        .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        input[type="text"], input[type="email"] {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.08);
            color: white;
            font-size: 14px;
            width: 200px;
        }

        input::placeholder { color: #94a3b8; }
        input:focus { outline: none; border-color: #6366f1; }

        .btn-add {
            background: #22c55e;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
        }

        .btn-add:hover { background: #16a34a; }

        .search-input {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.08);
            color: white;
            font-size: 14px;
            width: 220px;
            margin-left: auto;
        }

        /* TABLE */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            padding: 12px;
            text-align: left;
            color: #94a3b8;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td { padding: 12px; }

        tr { border-bottom: 1px solid rgba(255, 255, 255, 0.07); }
        tr:last-child { border-bottom: none; }
        tbody tr:hover { background: rgba(255,255,255,0.03); }

        /* ACTION BUTTONS */
        .btn-edit {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 6px;
            transition: 0.2s;
        }
        .btn-edit:hover { background: #d97706; }

        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
        }
        .btn-delete:hover { background: #dc2626; }

        /* ROLE BADGE */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .badge-admin { background: rgba(99,102,241,0.3); color: #a5b4fc; }
        .badge-user  { background: rgba(34,197,94,0.2); color: #86efac; }

        /* EXCEL BUTTON */
        .excel-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.2s;
        }
        .excel-btn:hover { background: #059669; }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
            font-weight: 500;
            z-index: 999;
        }

        /* MODAL */
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal.open { display: flex; }

        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 14px;
            width: 340px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal-content h3 { margin-bottom: 20px; }

        .modal-content input {
            display: block;
            width: 100%;
            margin-bottom: 14px;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.08);
            color: white;
            font-size: 14px;
        }

        .modal-actions { display: flex; gap: 10px; margin-top: 5px; }

        .btn-update {
            flex: 1;
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-cancel {
            flex: 1;
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        /* RESPONSIVE */
        @media(max-width:768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; display: flex; gap: 10px; padding: 15px; align-items: center; flex-wrap: wrap; }
            .sidebar p { display: none; }
            input[type="text"], input[type="email"] { width: 100%; }
            .search-input { margin-left: 0; width: 100%; }
            .stats-row { flex-direction: column; }
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <h2>üéì Admin</h2>
        <p id="adminEmail">Loading...</p>
        <a class="active">üìä Dashboard</a>
        <a>üë• Students</a>
    </div>

    <div class="main">

        <div class="header">
            <h1>Admin Dashboard</h1>
            <button class="logout" onclick="logout()">üö™ Logout</button>
        </div>

        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <h4>Total Students</h4>
                <span id="totalStudents">‚Äî</span>
            </div>
            <div class="stat-card">
                <h4>Admins</h4>
                <span id="totalAdmins">‚Äî</span>
            </div>
        </div>

        <!-- Add Student Form -->
        <div class="card">
            <div class="form-row">
                <input type="text" id="name" placeholder="Full Name">
                <input type="email" id="email" placeholder="Email">
                <button class="btn-add" onclick="addStudent()">+ Add Student</button>
                <input class="search-input" id="search" type="text" placeholder="üîç Search..." oninput="searchStudent()">
            </div>
        </div>

        <!-- Students Table -->
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studentTable">
                    <tr><td colspan="5" style="text-align:center;color:#94a3b8;padding:30px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <button class="excel-btn" onclick="downloadExcel()">‚¨á Download Excel</button>
    </div>

    <!-- EDIT MODAL -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Edit Student</h3>
            <input type="text" id="editName" placeholder="Name">
            <input type="email" id="editEmail" placeholder="Email">
            <div class="modal-actions">
                <button class="btn-update" onclick="updateStudent()">Update</button>
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ‚úÖ Change this to your deployed backend URL
        const BASE_URL = "https://java-backend-production-d7c2.up.railway.app";

        let students = [];
        let editingId = null;

        // ‚úÖ FIX: Get token from localStorage and send it with every request
        function getAuthHeaders() {
            const token = localStorage.getItem("token");
            return {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            };
        }

        // ‚úÖ FIX: Check if user is logged in as admin before anything loads
        function checkAuth() {
            const token = localStorage.getItem("token");
            if (!token) {
                window.location.href = "login.html";
                return false;
            }
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                if (payload.role !== "ADMIN") {
                    window.location.href = "login.html";
                    return false;
                }
                // Show admin email in sidebar
                document.getElementById("adminEmail").innerText = payload.sub;
                return true;
            } catch (e) {
                window.location.href = "login.html";
                return false;
            }
        }

        function showToast(msg, success = true) {
            const toast = document.getElementById("toast");
            toast.innerText = msg;
            toast.style.background = success ? "#22c55e" : "#ef4444";
            toast.style.display = "block";
            setTimeout(() => toast.style.display = "none", 2500);
        }

        async function loadStudents() {
            try {
                const res = await fetch(`${BASE_URL}/api/students`, {
                    headers: getAuthHeaders()  // ‚úÖ FIX: Send JWT token
                });

                if (res.status === 401 || res.status === 403) {
                    logout();
                    return;
                }

                if (!res.ok) throw new Error("Failed to load");

                students = await res.json();
                renderTable(students);

                const admins = students.filter(s => s.role === "ADMIN").length;
                const users  = students.filter(s => s.role !== "ADMIN").length;

                document.getElementById("totalStudents").innerText = users;
                document.getElementById("totalAdmins").innerText = admins;

            } catch (err) {
                document.getElementById("studentTable").innerHTML =
                    `<tr><td colspan="5" style="text-align:center;color:#ef4444;padding:30px;">Failed to load data</td></tr>`;
            }
        }

        function renderTable(data) {
            const table = document.getElementById("studentTable");
            if (data.length === 0) {
                table.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#94a3b8;padding:30px;">No students found</td></tr>`;
                return;
            }
            table.innerHTML = data.map(s => `
                <tr>
                    <td style="color:#94a3b8">#${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.email}</td>
                    <td>
                        <span class="badge ${s.role === 'ADMIN' ? 'badge-admin' : 'badge-user'}">
                            ${s.role}
                        </span>
                    </td>
                    <td>
                        <button class="btn-edit"   onclick="openEditModal(${s.id},'${escapeQuotes(s.name)}','${escapeQuotes(s.email)}')">Edit</button>
                        <button class="btn-delete" onclick="deleteStudent(${s.id})">Delete</button>
                    </td>
                </tr>
            `).join("");
        }

        function escapeQuotes(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, "&quot;");
        }

        async function addStudent() {
            const name  = document.getElementById("name").value.trim();
            const email = document.getElementById("email").value.trim();

            if (!name || !email) {
                showToast("Name and email are required ‚ùå", false);
                return;
            }

            try {
                const res = await fetch(`${BASE_URL}/api/register`, {
                    method: "POST",
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ name, email })
                });

                if (res.status === 409) {
                    showToast("Email already exists ‚ùå", false);
                    return;
                }
                if (!res.ok) throw new Error();

                document.getElementById("name").value = "";
                document.getElementById("email").value = "";
                loadStudents();
                showToast("Student added ‚úÖ");

            } catch (err) {
                showToast("Failed to add student ‚ùå", false);
            }
        }

        async function deleteStudent(id) {
            if (!confirm("Are you sure you want to delete this student?")) return;

            try {
                const res = await fetch(`${BASE_URL}/api/delete/${id}`, {
                    method: "DELETE",
                    headers: getAuthHeaders()  // ‚úÖ FIX: Send JWT token
                });

                if (!res.ok) throw new Error();
                loadStudents();
                showToast("Student deleted ‚úÖ");

            } catch (err) {
                showToast("Delete failed ‚ùå", false);
            }
        }

        function openEditModal(id, name, email) {
            editingId = id;
            document.getElementById("editName").value  = name;
            document.getElementById("editEmail").value = email;
            document.getElementById("editModal").classList.add("open");
        }

        function closeModal() {
            editingId = null;
            document.getElementById("editModal").classList.remove("open");
        }

        async function updateStudent() {
            const name  = document.getElementById("editName").value.trim();
            const email = document.getElementById("editEmail").value.trim();

            if (!name || !email) {
                showToast("Fields cannot be empty ‚ùå", false);
                return;
            }

            try {
                const res = await fetch(`${BASE_URL}/api/update/${editingId}`, {
                    method: "PUT",
                    headers: getAuthHeaders(),  // ‚úÖ FIX: Send JWT token
                    body: JSON.stringify({ name, email })
                });

                if (!res.ok) throw new Error();
                closeModal();
                loadStudents();
                showToast("Student updated ‚úÖ");

            } catch (err) {
                showToast("Update failed ‚ùå", false);
            }
        }

        function searchStudent() {
            const value = document.getElementById("search").value.toLowerCase();
            const filtered = students.filter(s =>
                s.name.toLowerCase().includes(value) ||
                s.email.toLowerCase().includes(value) ||
                s.role.toLowerCase().includes(value)
            );
            renderTable(filtered);
        }

        async function downloadExcel() {
            const token = localStorage.getItem("token");
            try {
                const res = await fetch(`${BASE_URL}/api/export`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (!res.ok) throw new Error();
                const blob = await res.blob();
                const url  = URL.createObjectURL(blob);
                const a    = document.createElement("a");
                a.href     = url;
                a.download = "students.xlsx";
                a.click();
                URL.revokeObjectURL(url);
            } catch (err) {
                showToast("Export failed ‚ùå", false);
            }
        }

        function logout() {
            localStorage.removeItem("token");
            window.location.href = "login.html";
        }

        // Close modal on backdrop click
        document.getElementById("editModal").addEventListener("click", function(e) {
            if (e.target === this) closeModal();
        });

        // ‚úÖ Init
        if (checkAuth()) {
            loadStudents();
        }
    </script>

</body>
</html>