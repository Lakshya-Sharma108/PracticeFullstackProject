<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }

        body {
            min-height: 100vh;
            display: flex;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
        }

        .sidebar {
            width: 220px;
            background: rgba(255, 255, 255, .05);
            backdrop-filter: blur(10px);
            padding: 30px 20px;
            flex-shrink: 0;
        }

        .sidebar h2 {
            margin-bottom: 6px;
            font-size: 18px;
        }

        .sidebar p {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 25px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sidebar a {
            display: block;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            color: #cbd5e1;
            text-decoration: none;
            cursor: pointer;
            transition: .2s;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background: #6366f1;
            color: white;
        }

        .main {
            flex: 1;
            padding: 30px;
            overflow-x: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .stats-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, .07);
            padding: 20px 25px;
            border-radius: 12px;
            flex: 1;
        }

        .stat-card h4 {
            color: #94a3b8;
            font-size: 13px;
            margin-bottom: 6px;
        }

        .stat-card span {
            font-size: 28px;
            font-weight: 700;
        }

        .card {
            background: rgba(255, 255, 255, .05);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        input[type=text],
        input[type=email] {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, .1);
            background: rgba(255, 255, 255, .08);
            color: white;
            font-size: 14px;
            width: 200px;
        }

        input::placeholder {
            color: #94a3b8;
        }

        input:focus {
            outline: none;
            border-color: #6366f1;
        }

        .search-input {
            width: 220px;
            margin-left: auto;
        }

        button {
            border: none;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            padding: 10px 16px;
            transition: .2s;
        }

        .btn-add {
            background: #22c55e;
            color: white;
        }

        .btn-add:hover {
            background: #16a34a;
        }

        .btn-logout {
            background: #ef4444;
            color: white;
        }

        .btn-logout:hover {
            background: #dc2626;
        }

        .btn-edit {
            background: #f59e0b;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
            margin-right: 6px;
        }

        .btn-edit:hover {
            background: #d97706;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .btn-excel {
            background: #10b981;
            color: white;
        }

        .btn-excel:hover {
            background: #059669;
        }

        .btn-update {
            flex: 1;
            background: #6366f1;
            color: white;
        }

        .btn-cancel {
            flex: 1;
            background: rgba(255, 255, 255, .1);
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            padding: 12px;
            text-align: left;
            color: #94a3b8;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: .5px;
        }

        td {
            padding: 12px;
        }

        tr {
            border-bottom: 1px solid rgba(255, 255, 255, .07);
        }

        tr:last-child {
            border-bottom: none;
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, .03);
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-admin {
            background: rgba(99, 102, 241, .3);
            color: #a5b4fc;
        }

        .badge-user {
            background: rgba(34, 197, 94, .2);
            color: #86efac;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal.open {
            display: flex;
        }

        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 14px;
            width: 340px;
            border: 1px solid rgba(255, 255, 255, .1);
        }

        .modal-content h3 {
            margin-bottom: 20px;
        }

        .modal-content input {
            display: block;
            width: 100%;
            margin-bottom: 14px;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, .1);
            background: rgba(255, 255, 255, .08);
            color: white;
            font-size: 14px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
            font-weight: 500;
            z-index: 999;
        }

        @media(max-width:768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                display: flex;
                gap: 10px;
                padding: 15px;
                flex-wrap: wrap;
                align-items: center;
            }

            .sidebar p {
                display: none;
            }

            input[type=text],
            input[type=email],
            .search-input {
                width: 100%;
            }

            .stats-row {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <h2>üéì Admin</h2>
        <p id="adminEmail">Loading...</p>
        <a class="active">üìä Dashboard</a>
        <a>üë• Students</a>
    </div>

    <div class="main">
        <div class="header">
            <h1>Admin Dashboard</h1>
            <button class="btn-logout" onclick="logout()">üö™ Logout</button>
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <h4>Total Users</h4><span id="totalUsers">‚Äî</span>
            </div>
            <div class="stat-card">
                <h4>Admins</h4><span id="totalAdmins">‚Äî</span>
            </div>
            <div class="stat-card">
                <h4>Students</h4><span id="totalStudents">‚Äî</span>
            </div>
        </div>

        <div class="card">
            <div class="form-row">
                <input type="text" id="name" placeholder="Full Name">
                <input type="email" id="email" placeholder="Email">
                <button class="btn-add" onclick="addStudent()">+ Add Student</button>
                <input class="search-input" type="text" id="search" placeholder="üîç Search..."
                    oninput="searchStudent()">
            </div>
        </div>

        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="studentTable">
                    <tr>
                        <td colspan="5" style="text-align:center;color:#94a3b8;padding:30px">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <button class="btn-excel" onclick="downloadExcel()">‚¨á Download Excel</button>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3>‚úèÔ∏è Edit Student</h3>
            <input type="text" id="editName" placeholder="Name">
            <input type="email" id="editEmail" placeholder="Email">
            <div class="modal-actions">
                <button class="btn-update" onclick="updateStudent()">Update</button>
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ‚úÖ Your Railway backend URL
        const BASE_URL = "https://java-backend-production-0cb2.up.railway.app";

        let students = [];
        let editingId = null;

        function authHeaders() {
            return {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${localStorage.getItem("token")}`
            };
        }

        function checkAuth() {
            const token = localStorage.getItem("token");
            if (!token) return redirect();
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                if (payload.role !== "ADMIN") return redirect();
                document.getElementById("adminEmail").innerText = payload.sub;
                return true;
            } catch { return redirect(); }
        }

        function redirect() { window.location.href = "login.html"; return false; }

        function showToast(msg, ok = true) {
            const t = document.getElementById("toast");
            t.innerText = msg;
            t.style.background = ok ? "#22c55e" : "#ef4444";
            t.style.display = "block";
            setTimeout(() => t.style.display = "none", 2500);
        }

        async function loadStudents() {
            try {
                const res = await fetch(`${BASE_URL}/api/students`, { headers: authHeaders() });
                if (res.status === 401 || res.status === 403) return redirect();
                students = await res.json();
                renderTable(students);

                const admins = students.filter(s => s.role === "ADMIN").length;
                const students_ = students.filter(s => s.role !== "ADMIN").length;
                document.getElementById("totalUsers").innerText = students.length;
                document.getElementById("totalAdmins").innerText = admins;
                document.getElementById("totalStudents").innerText = students_;
            } catch {
                document.getElementById("studentTable").innerHTML =
                    `<tr><td colspan="5" style="text-align:center;color:#ef4444;padding:30px">Failed to load data</td></tr>`;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById("studentTable");
            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#94a3b8;padding:30px">No students found</td></tr>`;
                return;
            }
            tbody.innerHTML = data.map(s => `
            <tr>
                <td style="color:#94a3b8">#${s.id}</td>
                <td>${s.name}</td>
                <td>${s.email}</td>
                <td><span class="badge ${s.role === 'ADMIN' ? 'badge-admin' : 'badge-user'}">${s.role}</span></td>
                <td>
                    <button class="btn-edit"   onclick="openEdit(${s.id},'${esc(s.name)}','${esc(s.email)}')">Edit</button>
                    <button class="btn-delete" onclick="deleteStudent(${s.id})">Delete</button>
                </td>
            </tr>`).join("");
        }

        function esc(str) { return str.replace(/'/g, "\\'").replace(/"/g, "&quot;"); }

        function searchStudent() {
            const q = document.getElementById("search").value.toLowerCase();
            renderTable(students.filter(s =>
                s.name.toLowerCase().includes(q) ||
                s.email.toLowerCase().includes(q) ||
                s.role.toLowerCase().includes(q)
            ));
        }

        async function addStudent() {
            const name = document.getElementById("name").value.trim();
            const email = document.getElementById("email").value.trim();
            if (!name || !email) { showToast("Name and email required ‚ùå", false); return; }

            const res = await fetch(`${BASE_URL}/api/register`, {
                method: "POST", headers: authHeaders(),
                body: JSON.stringify({ name, email })
            });
            if (res.status === 409) { showToast("Email already exists ‚ùå", false); return; }
            if (!res.ok) { showToast("Failed to add student ‚ùå", false); return; }

            document.getElementById("name").value = "";
            document.getElementById("email").value = "";
            loadStudents();
            showToast("Student added ‚úÖ");
        }

        async function deleteStudent(id) {
            if (!confirm("Delete this student?")) return;
            // ‚úÖ New endpoint: /api/students/{id}
            const res = await fetch(`${BASE_URL}/api/students/${id}`, {
                method: "DELETE", headers: authHeaders()
            });
            if (!res.ok) { showToast("Delete failed ‚ùå", false); return; }
            loadStudents();
            showToast("Student deleted ‚úÖ");
        }

        function openEdit(id, name, email) {
            editingId = id;
            document.getElementById("editName").value = name;
            document.getElementById("editEmail").value = email;
            document.getElementById("editModal").classList.add("open");
        }

        function closeModal() {
            editingId = null;
            document.getElementById("editModal").classList.remove("open");
        }

        async function updateStudent() {
            const name = document.getElementById("editName").value.trim();
            const email = document.getElementById("editEmail").value.trim();
            if (!name || !email) { showToast("Fields cannot be empty ‚ùå", false); return; }

            // ‚úÖ New endpoint: /api/students/{id}
            const res = await fetch(`${BASE_URL}/api/students/${editingId}`, {
                method: "PUT", headers: authHeaders(),
                body: JSON.stringify({ name, email })
            });
            if (!res.ok) { showToast("Update failed ‚ùå", false); return; }
            closeModal();
            loadStudents();
            showToast("Student updated ‚úÖ");
        }

        async function downloadExcel() {
            const res = await fetch(`${BASE_URL}/api/export`, {
                headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
            });
            if (!res.ok) { showToast("Export failed ‚ùå", false); return; }
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = "students.xlsx"; a.click();
            URL.revokeObjectURL(url);
        }

        function logout() {
            localStorage.removeItem("token");
            window.location.href = "login.html";
        }

        // Close modal on backdrop click
        document.getElementById("editModal").addEventListener("click", e => {
            if (e.target === document.getElementById("editModal")) closeModal();
        });

        if (checkAuth()) loadStudents();
    </script>
</body>

</html>